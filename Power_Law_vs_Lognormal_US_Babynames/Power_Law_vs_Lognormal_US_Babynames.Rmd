---
title: "Exercise04 Solution"
output:
  html_document: default
  pdf_document: default
---

## Goal:

1. Plot a histogram of baby name popularities for the year 2014. I.e. your 'x' axis should be how many people got a name, and the 'y' should be the count of how many names have that many named babies. Interpret the results and fit a power law. Is it a power law distribution?
2. Get many Twitter user profiles (in the order of a thousands) and plot the histograms of their status count, follower count, favorites count and friends count. Use maximum likelihood estimation to fit distributions to your data.





### Retrieve Baby name Data

Retrieve data from website, same as before
```{r message=FALSE, warning=FALSE}
URL = "https://www.ssa.gov/oact/babynames/names.zip"
dir.create("data")
download.file(URL, destfile = "./data/babyname.zip")
unzip("./data/babyname.zip", exdir = "./data")

```
1

Aggregate count based on name.
```{r message=FALSE, warning=FALSE}
library(dplyr)

table=data.frame()
for( i in 1960:2014){
  
filename= paste("./data/yob", i, ".txt", sep = "")
table = rbind(table ,read.csv(file=filename, header=FALSE, sep = ',', stringsAsFactors = FALSE))

}
colnames(table) = c("name", "gender", "count")
table = aggregate(count~name, data=table, FUN=sum)
table = table[order(table$count, decreasing = TRUE),]
```


Plot the log-log histogram of the baby name to see if it is a power law distribution
```{r}
count = table$count
r <- hist(count, plot=FALSE,breaks=50)
plot(r$mids, r$counts, log="xy", main = "Baby name Histogram", ylab ='frequency', xlab='babies')
```


```{r}
library(magrittr)

X = table$count
CCDF = ecdf(X)
xval = sort(unique(X))
yval = CCDF(xval)
plot(xval, 1-yval,log = "xy", main="Baby Name CCDF", ylab="P(X>x)", xlab='babies')
```


This function fits a power law distribution to the available data
```{r}
require(poweRlaw)
mm=displ$new(table$count)
mm$getXmin()
mm$getPars()
(est=estimate_pars(mm))
(est=estimate_xmin(mm))
mm$setXmin(est)
plot(mm)
lines(mm, col=2)
legend("bottomleft", "Power-law", col="red")
```






Bootstrapping of powerlaw distribution coeffcients
```{r}
# bs=bootstrap(mm, no_of_sims = 200, threads = 2)
# hist(bs$bootstraps[,2], breaks="fd")
# hist(bs$bootstraps[,3], breaks="fd")
# plot(jitter(bs$bootstraps[,2], factor=1.2), bs$bootstraps[,3])
# bs_p=bootstrap_p(mm, no_of_sims = 200, threads=2)
# bs_p$p

```


```{r}
mm2 = dislnorm$new(X)
#mm2$setXmin(30145) #If you want to analyze the top 1000
est2 = estimate_pars(mm2)
mm2$setPars(est2)
plot(mm,xlab="Baby name sample",ylab="Baby name counts", main="")
lines(mm, col=2)
lines(mm2, col=3)
legend("bottomleft", c("power-law","log-normal"), col=c(2,3), lwd=c(1,1))
```



### Twitter data
Log in to Twitter using the 'twitteR' package using your log in
```{r echo=FALSE}
require(twitteR)
consumer_key <- 'X2QkLTfDYZJQee3eZIfs4PbfO'
consumer_secret <- 'HKeDcjgqlRkhXGg4W0FBNa46xN05IRERWHCnvcI3hYhOKHgexh'
access_token <- '747703282408296448-J5EVuVKvBkz7fG22LsOURiZPG8IefB3'
access_secret <- 'TClX1U2Tscj0QCCL5fGVWwhjjx4m0vJjtuFrlqvHcwkLI'

setup_twitter_oauth(consumer_key, consumer_secret, access_token, access_secret)
```

Lookup 10k Twitter users by searching random Twitter IDs. This part takes time to run. 
```{r message=FALSE, warning=FALSE}
users=list()
while(length(users)<=20000){
  rate=getCurRateLimitInfo()
  
  while(as.numeric(rate$remaining[rate$resource=="/users/lookup"])<20){
    #the sleep is for waiting to reset the Twitter quota.
    Sys.sleep(100)
    rate=getCurRateLimitInfo()
    
    if(as.numeric(rate$remaining[rate$resource=="/users/lookup"])>=20){
      setup_twitter_oauth(consumer_key, consumer_secret, access_token, access_secret)
    }
  }
  
  a=ceiling(runif(2000, min=0, max=3E9))
  users=unique(c(lookupUsers(a),users))
}
```




```{r}
twtable=data.frame(matrix(0, ncol=5, nrow=length(users)))
colnames(twtable)=c("users", "status_count", "follower_count", "favorites_count", "friends_count")
```


```{r}
i=1
for (person in users){
  twtable$users[i] = person$screenName
  twtable$status_count[i] = sort(person$statusesCount)
  twtable$follower_count[i] = person$followersCount
  twtable$favorites_count[i] = person$favoritesCount
  twtable$friends_count[i] = person$friendsCount
  i=i+1
}
```


### Plotting the Distributions

```{r}
require(poweRlaw)


mm=displ$new(twtable$status_count[twtable$status_count!=0])
(est=estimate_pars(mm))
(est=estimate_xmin(mm))
mm$setXmin(est)
plot(mm)
lines(mm, col=2)

mm=displ$new(twtable$follower_count[twtable$follower_count!=0])
(est=estimate_pars(mm))
(est=estimate_xmin(mm))
mm$setXmin(est)
plot(mm)
lines(mm, col=2)

mm=displ$new(twtable$favorites_count[twtable$favorites_count!=0])
(est=estimate_pars(mm))
(est=estimate_xmin(mm))
mm$setXmin(est)
plot(mm)
lines(mm, col=2)

mm=displ$new(twtable$friends_count[twtable$friends_count!=0])
(est=estimate_pars(mm))
(est=estimate_xmin(mm))
mm$setXmin(est)
plot(mm)
lines(mm, col=2)


```





